---
# - name: Fix apt permission issues
#   ansible.builtin.file:
#     path: "{{ item }}"
#     owner: _apt
#     group: root
#     state: directory
#     recurse: true
#     mode: "0700"
#   with_items:
#     - /var/lib/apt/lists
#     - /var/cache/apt/archives/partial/

- name: Update repositories
  ansible.builtin.pacman:
    update_cache: yes

# - name: Get list of old Linux images and headers
#   ansible.builtin.shell: "dpkg-query -W -f='${binary:Package}\n' 'linux-image*' 'linux-headers*' | grep -v $(uname -r)"
#   register: old_packages
#   ignore_errors: true

# - name: Display old packages
#   ansible.builtin.debug:
#     var: old_packages.stdout_lines

# - name: Purge old packages
#   ansible.builtin.apt:
#     name: "{{ item }}"
#     state: absent
#     purge: true
#   with_items: "{{ old_packages.stdout_lines }}"

- name: List upgradable packages
  ansible.builtin.command: pacman -Qu
  register: list_updates_output

- name: Display list updates output
  ansible.builtin.debug:
    var: list_updates_output.stdout_lines

- name: Perform upgrade
  ansible.builtin.pacman:
    update_cache: yes
    upgrade: yes

# There is no 'full-upgrade' in pacman, as pacman always tries to upgrade fully by default.

- name: Install new packages
  ansible.builtin.pacman:
    name: "{{ item }}"
    state: present
  with_items: "{{ pacman_new_packages }}"
  when:
    - pacman_new_packages is defined
    - pacman_new_packages | length > 0

- name: Perform clean
  ansible.builtin.command: pacman -Sc --noconfirm
