---
# - name: Fix pacman permission issues (not typically required for pacman)
#   ansible.builtin.file:
#     path: "{{ item }}"
#     owner: root
#     group: root
#     state: directory
#     recurse: true
#     mode: "0700"
#   with_items:
#     - /var/lib/pacman/
#     - /var/cache/pacman/pkg/

- name: Update repositories
  ansible.builtin.pacman:
    update_cache: yes

# - name: Get list of old Linux images and headers (not applicable for pacman in the same way)
#   ansible.builtin.shell: "pacman -Qqe | grep -E 'linux-headers|linux-image' | grep -v $(uname -r)"
#   register: old_packages
#   ignore_errors: true

# - name: Display old packages
#   ansible.builtin.debug:
#     var: old_packages.stdout_lines

# - name: Purge old packages
#   ansible.builtin.pacman:
#     name: "{{ item }}"
#     state: absent
#   with_items: "{{ old_packages.stdout_lines }}"

- name: List upgradable packages
  ansible.builtin.command: pacman -Qu
  register: list_updates_output

- name: Display list updates output
  ansible.builtin.debug:
    var: list_updates_output.stdout_lines

- name: Perform upgrade
  ansible.builtin.pacman:
    upgrade: yes

- name: Perform full-upgrade (already covered by pacman -Syu)
  ansible.builtin.pacman:
    upgrade: yes

- name: Install new packages
  ansible.builtin.pacman:
    name: "{{ item }}"
    state: present
  with_items: "{{ required_packages }}"
  when:
    - required_packages is defined
    - required_packages | length > 0

- name: Perform clean
  ansible.builtin.command: pacman -Sc
